---
title: "sits Tutorial"
author: "Firman Hadi"
date: "10/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Sentinel-2/2A level 2A files in AWS are organized by sensor
# resolution. The AWS bands in 10m resolution are "B02", "B03", "B04", and "B08".
# The 20m bands are "B02", "B03", "B04", "B05", "B06", "BO7", B08", "B8A", "B11", and "B12".
# All 12 bands are available at 60m resolution. For creating data cubes from
# Sentinel-2/2A, users have to specify the `s2_resolution` parameter.

```{r library}
library(sits)
```

```{r cube}
# define the cube
roi <- c(xmin = 474578.8591,
         xmax = 519171.3366,
         ymin =  9167194.1834,
         ymax = 9197895.9217)
```

```{r data_dir}
#Set data directory
data_dir <- "/media/firmanhadi/My Passport/Research/Landcover/Sragen/sits/sragen_1_7_21/images"

#Test to load data_dir
data_dir
```


# Create datacube
# X1 : column one, X2 : column two
s2_local_cube <- sits_cube(
  source = "LOCAL",
  name = "T49MDM_MEM_2021",
  origin = "AWS",
  collection = "SENTINEL-S2-L2A",
  data_dir = data_dir,
  delim = "_",
  parse_info = c("X1", "tile", "band", "date" )
)

samples_S2_49MDM_MEM_2021_local <- sits_get_data(s2_local_cube, file = "sampel3.csv", multicores=8)

# Select samples with 3 bands
samples_s2_3bands <- sits_select(samples_S2_49MDM_MEM_2021_local,
                                 bands = c("B04","B08", "B11"))

# Select samples 6 bands
samples_s2_6bands <- sits_select(samples_S2_49MDM_MEM_2021_local,
                                 bands = c("B02","B03","B04", "B05","B08", "B11"))

# Training the model
# xgboost
# 3 bands
xgb_model3 <- sits_train(
  data      = samples_s2_3bands,
  ml_method = sits_xgboost()
)

# 6 bands
xgb_model6 <- sits_train(
  data      = samples_s2_6bands,
  ml_method = sits_xgboost()
)

#RandomForest
# 3 bands
rf_model3 <- sits_train(
  data      = samples_s2_3bands,
  ml_method = sits_rfor()
)

#6 bands
rf_model6 <- sits_train(
  data      = samples_s2_6bands,
  ml_method = sits_rfor()
)


# Classify the cube using the model

# xgboost
# 3 bands
s2_probs3_xgb <- sits_classify(
                          s2_local_cube,
                          xgb_model3,
                          roi = roi,
                          memsize = 12,
                          multicores = 8,
                          output_dir  = "./images_3bands_xgb/"
)

# 6 bands
s2_probs6_xgb <- sits_classify(
                          s2_local_cube,
                          xgb_model6,
                          roi = roi,
                          memsize = 8,
                          multicores = 6,
                          output_dir  = "./images_6band_xgb/"
)


# RandomForest

#3 bands
s2_probs3_rf <- sits_classify(
  s2_local_cube,
  rf_model3,
  roi = roi,
  memsize = 8,
  multicores = 6,
  output_dir  = "./images_3bands_rf/"
)

# 6 bands
s2_probs6_rf <- sits_classify(
  s2_local_cube,
  rf_model6,
  roi = roi,
  memsize = 8,
  multicores = 6,
  output_dir  = "./images_6bands_rf/"
)


# plot the probabilities
# xgboost
plot(s2_probs3_xgb)
plot(s2_probs6_xgb)

# RandomForest
plot(s2_probs3_rf)
plot(s2_probs6_rf)

# Smoothing 
#xgboost
s2_bayes3_xgb <- sits_smooth(s2_probs3_xgb, type = "bayes", output_dir = "./images_3bands_xgb/")
s2_bayes6_xgb <- sits_smooth(s2_probs6_xgb, type = "bayes", output_dir = "./images_6band_xgb/")

#RandomForest
s2_bayes3_rf <- sits_smooth(s2_probs3_rf, type = "bayes", output_dir = "./images_3bands_rf/")
s2_bayes6_rf <- sits_smooth(s2_probs6_rf, type = "bayes", output_dir = "./images_6bands_rf/")

plot(s2_bayes3_xgb)
plot(s2_bayes6_xgb)

# Labeling, create classification maps
#xgboost
s2_label3_xgb <- sits_label_classification(s2_bayes3_xgb, output_dir = "./images_3bands_xgb/")
s2_label6_xgb <- sits_label_classification(s2_bayes6_xgb, output_dir = "./images_6band_xgb/")

#RandomForest
s2_label3_rf <- sits_label_classification(s2_bayes3_rf, output_dir = "./images_3bands_rf/")
s2_label6_rf <- sits_label_classification(s2_bayes6_rf, output_dir = "./images_6bands_rf/")
# plot the labelled images
plot(s2_label3_xgb)
plot(s2_label6_xgb)

#validation
#3 bands
val_xgboost3 <- sits_kfold_validate(samples_s2_3bands, 
                                folds = 5, 
                                ml_method = sits_xgboost())
#6 bands
val_xgboost6 <- sits_kfold_validate(samples_s2_6bands, 
                                    folds = 5, 
                                    ml_method = sits_xgboost())
# Show the validation result
val_xgboost3
val_xgboost6

# # Accuracy
# xgb_model <- sits_train(samples_s2_5bands, ml_method = sits_xgboost())
# 
# # Classify the data cube with xgb model
# probs_cube <- sits_classify(s2_cube_regular, xgb_model)
# # label the classification
# label_cube <- sits_label_classification(probs_cube, output_dir = tempdir())
# plot(label_cube)
# # get ground truth point
# ground_truth <- system.file("extdata/samples/samples_sinop_crop.csv",
#                             package = "sits")
# # calculate accuracy according to Olofsson's method
# area_acc <- sits_accuracy(label_cube, validation_csv = ground_truth)
# # print the area estimated accuracy 
# area_acc

